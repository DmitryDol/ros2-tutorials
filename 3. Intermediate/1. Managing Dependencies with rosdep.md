# Managing Dependencies with rosdep

**Цель:** Управление внешними зависимостями с помощью `rosdep`.

`rosdep` - это утилита управления зависимостями, которая может работать с пакетами и внешними библиотеками. Это утилита командной строки для определения и установки зависимостей для сборки или установки пакета. `rosdep` не является самостоятельным менеджером пакетов; это мета-менеджер пакетов, который использует свои собственные знания о системе и зависимостях для поиска подходящего пакета для установки на конкретную платформу. Фактическая установка выполняется с помощью системного менеджера пакетов (например, `apt` в Ubuntu).

Чаще всего его вызывают перед сборкой рабочего пространства, где он используется для установки зависимостей пакетов, входящих в это рабочее пространство.

Он может работать как с одним пакетом, так и с каталогом пакетов (например, с рабочим пространством).

## Немного о файлах package.xml

Файл `package.xml` - это файл в вашем программном обеспечении, в котором `rosdep` находит набор зависимостей. Важно, чтобы список зависимостей в `package.xml` был полным и корректным, что позволит всем инструментам определять зависимости пакетов. Отсутствие или некорректность зависимостей может привести к тому, что пользователи не смогут использовать ваш пакет, пакеты в рабочем пространстве будут собраны не по порядку или не смогут быть выпущены.

Зависимости в файле `package.xml` обычно называются «ключами rosdep». Эти зависимости вносятся в файл `package.xml` вручную создателями пакета и должны представлять собой полный список всех библиотек и пакетов, не требующих сборки.

Они представлены в следующих тегах:

`<depend>`.

Это зависимости, которые должны быть предоставлены как во время сборки, так и во время выполнения вашего пакета. Для пакетов C++, если есть сомнения, используйте этот тег. Пакеты на чистом Python обычно не имеют фазы сборки, поэтому никогда не следует использовать этот тег, а вместо него следует использовать `<exec_depend>`.

`<build_depend>`

Если вы используете определенную зависимость только для сборки вашего пакета, а не во время выполнения, вы можете использовать тег `<build_depend>`.

При таком типе зависимости установленный двоичный файл вашего пакета не требует установки этого конкретного пакета.

Однако может возникнуть проблема, если ваш пакет экспортирует заголовок, который включает заголовок из этой зависимости. В этом случае вам также понадобится `<build_export_depend>`.

`<build_export_depend>`.

Если вы экспортируете заголовок, включающий заголовок из зависимости, он будет необходим другим пакетам, которые  зависят через `<build_depend>` от вашего. В основном это относится к заголовкам и конфигурационным файлам CMake. Пакеты библиотек, на которые ссылаются экспортируемые вами библиотеки, обычно должны быть указаны в `<depend>`, поскольку они также необходимы во время выполнения.

`<exec_depend>`

Этот тег объявляет зависимости для разделяемых библиотек, исполняемых файлов, модулей Python, сценариев запуска и других файлов, необходимых при запуске вашего пакета.

`<test_depend>`

Этот тег объявляет зависимости, необходимые только для тестов. Зависимости здесь *не* должны дублироваться с ключами, указанными в `<build_depend>`, `<exec_depend>` или `<depend>`.

## Как работает rosdep?

`rosdep` проверяет файлы `package.xml` в своем пути или для конкретного пакета и находит хранящиеся в них ключи rosdep. Затем эти ключи сверяются с центральным индексом для поиска соответствующего пакета ROS или программной библиотеки в различных менеджерах пакетов. Наконец, когда пакеты найдены, они устанавливаются и становятся готовыми к работе.

`rosdep` работает, получая центральный индекс на вашей локальной машине, чтобы не обращаться к сети при каждом запуске.

Центральный индекс известен как `rosdistro`, который можно найти в Интернете.

## Как узнать, какие ключи указывать в package.xml?

* Если пакет, от которого вы хотите создать зависимость, основан на ROS И был выпущен в экосистеме ROS, например, `nav2_bt_navigator`, вы можете просто использовать имя пакета. Список всех выпущенных пакетов ROS можно найти в [https://github.com/ros/rosdistro](https://github.com/ros/rosdistro) в файле `humble/distribution.yaml`.
* Если вам нужна зависимость от пакета, не связанного с ROS (так называемые "системные зависимости"), вам потребуется найти ключи для конкретной библиотеки. В общем случае, есть два важных файла:
  * rosdep/base.yaml содержит системные зависимости `apt`
  * rosdep/python.yaml содержит зависимости Python

Чтобы найти ключ, выполните поиск вашей библиотеки в этих файлах и найдите её имя. Это и будет ключ, который нужно указать в файле `package.xml`.

Например, представим, что у пакета есть зависимость от `doxygen`, потому что это программное обеспечение, которое заботится о качественной документации. Мы бы искали `doxygen` в `rosdep/base.yaml` и нашли бы:

```yaml
doxygen:
  arch: [doxygen]
  debian: [doxygen]
  fedora: [doxygen]
  freebsd: [doxygen]
  gentoo: [app-doc/doxygen]
  macports: [doxygen]
  nixos: [doxygen]
  openembedded: [doxygen@meta-oe]
  opensuse: [doxygen]
  rhel: [doxygen]
  ubuntu: [doxygen]
```

Это означает, что наш ключ rosdep - `doxygen`, который будет преобразовываться в эти различные имена в менеджерах пакетов различных операционных систем для установки.

## Как использовать rosdep?

### Установка rosdep

Если вы используете `rosdep` с ROS, он удобно поставляется вместе с дистрибутивом ROS. Это рекомендуемый способ получения `rosdep`. Вы можете установить его с помощью:

```shell
apt-get install python3-rosdep
```

В Ubuntu есть другой пакет с похожим названием - `python3-rosdep2`. Если этот пакет установлен, убедитесь, что удалили его перед установкой `python3-rosdep`.

### Работа с rosdep

Теперь, когда мы имеем некоторое понимание `rosdep`, `package.xml` и `rosdistro`, мы готовы использовать саму утилиту! Во-первых, если вы используете `rosdep` впервые, его необходимо инициализировать:

```shell
sudo rosdep init
rosdep update
```

Это инициализирует rosdep, а команда `update` обновит локально кэшированный индекс rosdistro. Рекомендуется периодически выполнять `update` для получения последней версии.

Наконец, мы можем запустить `rosdep install` для установки зависимостей. Обычно это выполняется для рабочего пространства с несколькими пакетами одной командой для установки всех зависимостей. Если вы находитесь в корне рабочего пространства с директорией `src`, содержащей исходный код, команда будет выглядеть так:

```shell
rosdep install --from-paths src -y --ignore-src
```

Разберём параметры:

* `--from-paths src` указывает путь для поиска файлов `package.xml`, по которым будут определяться ключи
* `-y` означает автоматический ответ "да" на все запросы менеджера пакетов для установки без подтверждений
* `--ignore-src` означает игнорирование установки зависимостей, даже если существует ключ rosdep, если сам пакет также находится в рабочем пространстве.
